<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>积分充值 - LEAL账号报单系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <!-- 使用ES模块方式导入supabase -->
    <script type="module">
        import { supabase } from './js/supabase.js';
        // 将导入的supabase赋值给全局变量，供其他脚本使用
        window.supabaseClient = supabase;
    </script>
    <style>
        /* 自定义样式 */
        .modal-backdrop {
            backdrop-filter: blur(2px);
        }
        .history-item:hover {
            background-color: #f9fafb;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav id="navbar" class="bg-blue-600 text-white shadow-md">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <a href="index.html" class="text-xl font-bold">LEAL账号报单系统</a>
            
            <!-- 桌面导航 -->
            <div class="hidden md:flex space-x-6">
                <a href="index.html" class="hover:text-blue-200 transition">首页</a>
                <a href="announcement.html" class="hover:text-blue-200 transition">公告</a>
                <a href="contact.html" class="hover:text-blue-200 transition">联系客服</a>
                <a href="get-account.html" class="hover:text-blue-200 transition">获取账号</a>
                <a href="recycle-account.html" class="hover:text-blue-200 transition">账号回收</a>
                <a href="points.html" class="hover:text-blue-200 transition">积分兑换</a>
                <a href="PointsTop-up.html" class="hover:text-blue-200 transition font-semibold border-b-2 border-white">积分充值</a>
                <div id="auth-links">
                    <span id="user-email" class="mr-3"></span>
                    <span id="user-points" class="mr-3">积分：加载中</span>
                    <button id="logout-btn" class="hover:text-blue-200 transition">退出登录</button>
                </div>
            </div>
            
            <!-- 移动端菜单按钮 -->
            <button id="mobile-menu-button" class="md:hidden text-white focus:outline-none">
                <i class="fa fa-bars text-xl"></i>
            </button>
        </div>
        
        <!-- 移动端导航菜单 -->
        <div id="mobile-menu" class="md:hidden hidden bg-blue-700">
            <div class="container mx-auto px-4 py-2 flex flex-col space-y-3">
                <a href="index.html" class="py-2 hover:text-blue-200 transition">首页</a>
                <a href="announcement.html" class="py-2 hover:text-blue-200 transition">公告</a>
                <a href="contact.html" class="py-2 hover:text-blue-200 transition">联系客服</a>
                <a href="get-account.html" class="py-2 hover:text-blue-200 transition">获取账号</a>
                <a href="recycle-account.html" class="py-2 hover:text-blue-200 transition">账号回收</a>
                <a href="points.html" class="py-2 hover:text-blue-200 transition">积分兑换</a>
                <a href="PointsTop-up.html" class="py-2 hover:text-blue-200 transition font-semibold">积分充值</a>
                <div id="mobile-auth-links" class="py-2">
                    <span id="mobile-user-email"></span>
                    <span id="mobile-user-points" class="ml-3">积分：加载中</span>
                    <button id="mobile-logout-btn" class="hover:text-blue-200 transition ml-3">退出登录</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 联系客服模态框 -->
    <div id="contact-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-80 p-6 relative">
            <button id="contact-modal-close" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700" aria-label="关闭">
                <i class="fa fa-times"></i>
            </button>
            <h3 class="text-lg font-semibold mb-2">联系客服</h3>
            <p class="text-gray-700">微信：<span class="font-mono font-bold text-blue-600">2751491484</span></p>
            <div class="mt-4 flex justify-end space-x-2">
                <button id="contact-modal-copy" class="bg-blue-600 text-white px-3 py-1.5 rounded hover:bg-blue-700">复制微信</button>
                <button id="contact-modal-ok" class="border px-3 py-1.5 rounded hover:bg-gray-50">知道了</button>
            </div>
        </div>
    </div>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <div class="text-center mb-10">
                <h1 class="text-3xl font-bold text-gray-800">积分充值</h1>
                <p class="text-gray-600 mt-2">请扫描二维码完成支付，然后上传支付截图。后台审核通过后为您充值对应积分。</p>
            </div>
            
            <!-- 用户信息提示栏 -->
            <div class="bg-blue-50 border border-blue-100 rounded-md p-4 mb-8">
                <p class="text-gray-700">账号：<span id="user-account" class="font-medium">未登录</span></p>
                <p class="text-gray-700">积分数量：<span id="available-points" class="font-medium text-green-600">0</span></p>
                <!-- <p class="text-gray-700">冷却积分：<span id="cooling-points" class="font-medium text-yellow-600">0</span>（<span id="cooldown-remaining" class="font-medium text-gray-600">--</span>后解锁）</p> -->
                <!-- 保留一个隐藏的占位元素以避免旧代码引用报错 -->
                <span id="current-points" class="hidden"></span>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- 支付二维码部分 -->
                    <div class="text-center">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">支付二维码</h3>
                        <div class="bg-gray-50 p-4 rounded-lg inline-block border border-gray-200">
                            <img src="1.png" alt="支付二维码占位图" class="max-w-full h-auto rounded-md max-h-[300px]" />
                        </div>
                        <p class="text-gray-600 mt-4 text-sm">若二维码失效，请联系客服获取最新二维码</p>
                    </div>

                    <!-- 上传表单部分 -->
                    <div>
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">上传支付截图</h3>
                        <form id="topup-form" class="space-y-4">
                            <div>
                                <label for="screenshot" class="block text-sm font-medium text-gray-700 mb-1">选择图片文件</label>
                                <input id="screenshot" type="file" accept="image/*" required 
                                    class="block w-full text-sm text-gray-500
                                        file:mr-4 file:py-2 file:px-4
                                        file:rounded-md file:border-0
                                        file:text-sm file:font-medium
                                        file:bg-blue-600 file:text-white
                                        hover:file:bg-blue-700
                                        cursor-pointer" />
                            </div>
                            <div>
                                <label for="note" class="block text-sm font-medium text-gray-700 mb-1">备注（可选）</label>
                                <input id="note" type="text" placeholder="支付方式/金额等信息" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                            </div>
                            <button id="submit-btn" type="submit" 
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-200">
                                提交充值申请
                            </button>
                            <p id="form-tip" class="text-sm text-gray-600 text-center"></p>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 充值申请历史 -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">我的充值申请</h3>
                <div id="history-list" class="space-y-3"></div>
                <p id="history-empty" class="text-center text-gray-500 py-8">暂无充值申请</p>
            </div>
        </div>
    </main>

    <script>
        // supabaseClient 已通过ES模块导入
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof checkAuth === 'function') {
                checkAuth();
            }
        });
    </script>
    <script>
        // 移动端菜单切换
        document.getElementById('mobile-menu-button').addEventListener('click', function() {
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenu.classList.toggle('hidden');
        });

        // 联系客服模态框功能
        document.querySelectorAll('a[href="contact.html"]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('contact-modal').classList.remove('hidden');
                document.getElementById('contact-modal').classList.add('flex');
            });
        });

        document.getElementById('contact-modal-close').addEventListener('click', closeContactModal);
        document.getElementById('contact-modal-ok').addEventListener('click', closeContactModal);
        document.getElementById('contact-modal-copy').addEventListener('click', function() {
            navigator.clipboard.writeText('2751491484').then(() => {
                alert('微信已复制到剪贴板');
            });
        });

        function closeContactModal() {
            document.getElementById('contact-modal').classList.add('hidden');
            document.getElementById('contact-modal').classList.remove('flex');
        }

        // 主要业务逻辑
        let currentUser = null;
        
        // 退出登录
        async function logout() {
            const { error } = await supabaseClient.auth.signOut();
            if (!error) {
                window.location.reload();
            }
        }
        
        async function checkAuth() {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) {
                    location.href = 'login.html';
                    return;
                }
                currentUser = session.user;
                
                // 获取用户信息并更新界面
                await updateUserInfo(currentUser);
            } catch (e) {
                console.error('认证错误', e);
            }
        }
        
        async function updateUserInfo(user) {
            try {
                // 获取用户基本信息（用户名）
                const { data: userData } = await supabaseClient
                    .from('users')
                    .select('username')
                    .eq('id', user.id)
                    .single();
                
                if (userData) {
                    // 更新用户信息显示
                    document.getElementById('user-account').textContent = userData.username || user.email.split('@')[0];
                    document.getElementById('user-email').textContent = user.email;
                    document.getElementById('mobile-user-email').textContent = user.email;
                }
                
                // 添加退出登录事件
                document.getElementById('logout-btn').addEventListener('click', logout);
                document.getElementById('mobile-logout-btn').addEventListener('click', logout);
                
                // 获取积分汇总视图
                const { data: summary } = await supabaseClient
                    .from('user_points_summary')
                    .select('total_earned, available_points')
                    .eq('user_id', user.id)
                    .single();
                
                if (summary) {
                    const userPoints = {
                        current: summary.total_earned || 0,
                        available: summary.available_points || 0
                    };
                    
                    // 更新页面显示
                    const currentPoints = document.getElementById('current-points');
                    const availablePoints = document.getElementById('available-points');
                    
                    if (currentPoints) currentPoints.textContent = userPoints.current;
                    availablePoints.textContent = userPoints.available;
                    
                    // 更新导航栏积分（显示总可用）
                    const ptsEl = document.getElementById('user-points');
                    const mPtsEl = document.getElementById('mobile-user-points');
                    if (ptsEl) ptsEl.textContent = `积分：${userPoints.available}`;
                    if (mPtsEl) mPtsEl.textContent = `积分：${userPoints.available}`;
                }
            } catch (error) {
                console.error('更新用户信息失败:', error);
            }
        }

        async function uploadScreenshot(file) {
            const ts = Date.now();
            const ext = (file.name.split('.').pop() || 'png').toLowerCase();
            const path = `wechat_pay/${currentUser.id}/${ts}.${ext}`;
            const { error } = await supabaseClient.storage.from('screenshots').upload(path, file, { contentType: file.type });
            if (error) throw error;
            const { data } = supabaseClient.storage.from('screenshots').getPublicUrl(path);
            return data.publicUrl;
        }

        async function createTopupApplication(url, note) {
            const { error } = await supabaseClient
                .from('topup_applications')
                .insert([{ user_id: currentUser.id, screenshot_url: url, status: 'pending', note }]);
            if (error) throw error;
        }

        async function loadHistory() {
            const list = document.getElementById('history-list');
            const empty = document.getElementById('history-empty');
            list.innerHTML = '';
            
            try {
                const { data, error } = await supabaseClient
                    .from('topup_applications')
                    .select('id,status,points_awarded,review_note,screenshot_url,created_at')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('加载历史记录失败:', error);
                    return;
                }
                
                if (!data || data.length === 0) {
                    empty.style.display = 'block';
                    return;
                } else {
                    empty.style.display = 'none';
                }
                
                data.forEach(record => {
                    const item = document.createElement('div');
                    item.className = 'p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors';
                    
                    // 设置状态颜色
                    let statusColor = 'text-gray-600';
                    let statusText = '处理中';
                    
                    if (record.status === 'approved') {
                        statusColor = 'text-green-600';
                        statusText = '已通过';
                    } else if (record.status === 'rejected') {
                        statusColor = 'text-red-600';
                        statusText = '已拒绝';
                    } else if (record.status === 'pending') {
                        statusColor = 'text-yellow-600';
                        statusText = '待审核';
                    }
                    
                    item.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-semibold ${statusColor}">${statusText}</span>
                            ${record.points_awarded ? 
                                `<span class="text-green-600 font-medium">+${record.points_awarded} 积分</span>` : 
                                ''}
                        </div>
                        <div class="text-sm text-gray-600 mb-2">
                            提交时间：${new Date(record.created_at).toLocaleString()}
                        </div>
                        ${record.review_note ? 
                            `<div class="text-sm text-gray-600 mb-2">
                                审核备注：${record.review_note}
                            </div>` : 
                            ''}
                        <a href="${record.screenshot_url}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm">
                            <i class="fa fa-eye mr-1"></i> 查看截图
                        </a>
                    `;
                    
                    list.appendChild(item);
                });
            } catch (error) {
                console.error('加载历史记录时发生错误:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            const form = document.getElementById('topup-form');
            const tip = document.getElementById('form-tip');
            const btn = document.getElementById('submit-btn');
            
            // 加载历史记录
            await loadHistory();
            
            // 表单提交处理
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const fileInput = document.getElementById('screenshot');
                const file = fileInput.files[0];
                const note = document.getElementById('note').value || null;
                
                if (!file) {
                    tip.textContent = '请先选择支付截图';
                    tip.className = 'text-sm text-red-600 text-center';
                    return;
                }
                
                // 防止重复提交
                btn.disabled = true;
                btn.textContent = '提交中...';
                tip.textContent = '正在处理，请稍候...';
                tip.className = 'text-sm text-blue-600 text-center';
                
                try {
                    // 上传截图
                    const url = await uploadScreenshot(file);
                    // 创建充值申请
                    await createTopupApplication(url, note);
                    
                    // 成功处理
                    tip.textContent = '提交成功，请等待审核！';
                    tip.className = 'text-sm text-green-600 text-center';
                    form.reset();
                    // 重新加载历史记录
                    await loadHistory();
                } catch (err) {
                    console.error('提交失败:', err);
                    tip.textContent = '提交失败：' + (err.message || '未知错误');
                    tip.className = 'text-sm text-red-600 text-center';
                } finally {
                    // 恢复按钮状态
                    btn.disabled = false;
                    btn.textContent = '提交充值申请';
                }
            });
        });
    </script>
</body>
</html>