<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase 连接测试</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #3ecf8e;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #32a875;
        }
        button:disabled {
            background-color: #9ae6b4;
            cursor: not-allowed;
        }
        .status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .loading {
            background-color: #dbeafe;
            color: #1e40af;
        }
        pre {
            background-color: #1a1a1a;
            color: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Supabase 连接测试</h1>
        
        <div class="input-group">
            <label for="supabaseUrl">Supabase URL:</label>
            <input type="text" id="supabaseUrl" value="https://fvvqgavlqchgqknyjymv.supabase.co">
        </div>
        
        <div class="input-group">
            <label for="supabaseKey">Supabase Anon Key:</label>
            <input type="text" id="supabaseKey" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ2dnFnYXZscWNoZ3FrbnlqeW12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MDY3NDY0MTIsImV4cCI6MjAyMjMyMjQxMn0.cg26M2MZ0zY7sUqO7sXvjBZc48b9x96QV386sTt3IY4">
        </div>
        
        <button id="testConnection">测试连接</button>
        
        <div id="connectionStatus" class="status"></div>
        
        <h2>调试信息</h2>
        <pre id="debugInfo">// 等待测试结果...</pre>
    </div>
    
    <script>
        // 显示调试信息
        function logDebugInfo(info) {
            const debugElement = document.getElementById('debugInfo');
            debugElement.textContent = info;
        }
        
        // 显示状态信息
        function showStatus(message, type) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.textContent = message;
            statusElement.className = 'status ' + type;
        }
        
        // 检查Supabase库是否加载
        function checkSupabaseLibrary() {
            let debugInfo = "Supabase库加载检查:\n";
            debugInfo += "window.supabase: " + (window.supabase ? "已定义" : "未定义") + "\n";
            debugInfo += "window.createClient: " + (window.createClient ? "已定义" : "未定义") + "\n";
            
            if (window.supabase && typeof window.supabase.createClient === 'function') {
                debugInfo += "✓ 找到 supabase.createClient 函数";
                logDebugInfo(debugInfo);
                return window.supabase.createClient;
            } else if (window.createClient) {
                debugInfo += "✓ 找到全局 createClient 函数";
                logDebugInfo(debugInfo);
                return window.createClient;
            } else {
                debugInfo += "✗ 未找到可用的createClient函数";
                logDebugInfo(debugInfo);
                return null;
            }
        }
        
        // 测试Supabase连接
        async function testSupabaseConnection() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;
            const testBtn = document.getElementById('testConnection');
            
            // 禁用按钮并显示加载状态
            testBtn.disabled = true;
            testBtn.textContent = "测试中...";
            showStatus("正在测试连接...", "loading");
            
            // 检查Supabase库
            const createClient = checkSupabaseLibrary();
            
            if (!createClient) {
                showStatus("Supabase库加载失败，请刷新页面重试", "error");
                testBtn.disabled = false;
                testBtn.textContent = "测试连接";
                return;
            }
            
            try {
                // 初始化Supabase客户端
                const supabase = createClient(url, key);
                logDebugInfo(logDebugInfo.textContent + "\n\n初始化结果: ✅ 客户端创建成功");
                
                // 尝试执行简单查询
                logDebugInfo(logDebugInfo.textContent + "\n\n执行测试查询...");
                const { data, error } = await supabase
                    .from('game_accounts')
                    .select('*')
                    .limit(1);
                
                if (error) {
                    logDebugInfo(logDebugInfo.textContent + "\n查询结果: ❌ 失败");
                    logDebugInfo(logDebugInfo.textContent + "\n错误信息: " + JSON.stringify(error, null, 2));
                    showStatus("连接成功，但查询失败。请确保数据库表已创建并设置了正确的RLS策略。", "error");
                } else {
                    logDebugInfo(logDebugInfo.textContent + "\n查询结果: ✅ 成功");
                    logDebugInfo(logDebugInfo.textContent + "\n返回数据: " + (data.length > 0 ? "有数据返回" : "无数据(表可能为空)"));
                    showStatus("连接和查询成功！Supabase配置正确。", "success");
                }
            } catch (err) {
                logDebugInfo(logDebugInfo.textContent + "\n\n发生异常: " + err.message);
                showStatus("连接测试失败: " + err.message, "error");
            } finally {
                // 恢复按钮状态
                testBtn.disabled = false;
                testBtn.textContent = "测试连接";
            }
        }
        
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', () => {
            // 绑定测试按钮点击事件
            document.getElementById('testConnection').addEventListener('click', testSupabaseConnection);
            
            // 显示初始调试信息
            logDebugInfo("// 页面已加载\n// 点击'测试连接'按钮开始测试");
        });
    </script>
</body>
</html>