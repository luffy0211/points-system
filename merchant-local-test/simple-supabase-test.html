<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase连接测试</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 14px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #0069d9;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>Supabase连接测试</h1>
    
    <div>
        <h3>连接信息</h3>
        <p>Supabase URL: <code>https://tdwwcqaxlwqrnjrjhsmn.supabase.co</code></p>
        <p>Supabase Anon Key: <code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkd3djcWF4bHdxcm5qcmpoc21uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MjA1MjIsImV4cCI6MjA3ODA5NjUyMn0.wA6EFlKk_Wbs7ZTOS2HoyRTMa_D0DI3BXXAGOEnnLWM</code></p>
    </div>
    
    <div>
        <h3>操作</h3>
        <button id="test-connection">测试连接</button>
        <button id="test-table" disabled>测试表访问</button>
    </div>
    
    <div>
        <h3>状态</h3>
        <div id="connection-status" class="status">
            等待测试...
        </div>
    </div>
    
    <div>
        <h3>详细输出</h3>
        <pre id="output">准备就绪...</pre>
    </div>

    <script>
        // DOM元素
        const testConnectionBtn = document.getElementById('test-connection');
        const testTableBtn = document.getElementById('test-table');
        const statusDiv = document.getElementById('connection-status');
        const outputPre = document.getElementById('output');
        
        // 全局Supabase客户端
        let supabaseClient = null;
        
        // 输出日志
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            outputPre.textContent += `\n[${timestamp}] ${message}`;
            outputPre.scrollTop = outputPre.scrollHeight;
        }
        
        // 更新状态
        function updateStatus(message, type = 'info') {
            statusDiv.textContent = message;
            statusDiv.className = 'status';
            
            if (type === 'success') {
                statusDiv.classList.add('success');
            } else if (type === 'error') {
                statusDiv.classList.add('error');
            } else if (type === 'warning') {
                statusDiv.classList.add('warning');
            }
        }
        
        // 测试连接
        testConnectionBtn.addEventListener('click', async () => {
            try {
                testConnectionBtn.disabled = true;
                updateStatus('正在连接...', 'warning');
                log('开始连接测试...');
                
                // 显式从window中获取supabase-js
                const supabaseJs = window['@supabase/supabase-js'];
                log('获取Supabase JS库: ' + (supabaseJs ? '成功' : '失败'));
                
                if (!supabaseJs || !supabaseJs.createClient) {
                    throw new Error('无法找到createClient函数，请检查Supabase JS库是否正确加载');
                }
                
                // 使用提供的凭据创建客户端
                const URL = 'https://tdwwcqaxlwqrnjrjhsmn.supabase.co';
                const KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkd3djcWF4bHdxcm5qcmpoc21uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MjA1MjIsImV4cCI6MjA3ODA5NjUyMn0.wA6EFlKk_Wbs7ZTOS2HoyRTMa_D0DI3BXXAGOEnnLWM';
                
                log('尝试创建Supabase客户端...');
                supabaseClient = supabaseJs.createClient(URL, KEY);
                
                if (!supabaseClient) {
                    throw new Error('创建Supabase客户端失败');
                }
                
                log('Supabase客户端创建成功');
                updateStatus('连接成功！', 'success');
                testTableBtn.disabled = false;
                
            } catch (error) {
                console.error('连接错误:', error);
                log('连接失败: ' + error.message);
                updateStatus('连接失败: ' + error.message, 'error');
                supabaseClient = null;
                testTableBtn.disabled = true;
            } finally {
                testConnectionBtn.disabled = false;
            }
        });
        
        // 测试表访问
        testTableBtn.addEventListener('click', async () => {
            if (!supabaseClient) {
                updateStatus('请先连接到Supabase', 'warning');
                return;
            }
            
            try {
                testTableBtn.disabled = true;
                updateStatus('正在测试表访问...', 'warning');
                log('开始测试表访问...');
                
                // 尝试访问game_accounts表
                log('尝试访问game_accounts表...');
                const { data, error } = await supabaseClient
                    .from('game_accounts')
                    .select('*')
                    .limit(5);
                
                if (error) {
                    throw error;
                }
                
                log('表访问成功！获取到 ' + (data ? data.length : 0) + ' 条记录');
                if (data && data.length > 0) {
                    log('返回的数据示例: ' + JSON.stringify(data[0], null, 2).substring(0, 200) + '...');
                }
                
                updateStatus('表访问成功！共获取到 ' + (data ? data.length : 0) + ' 条账号记录', 'success');
                
            } catch (error) {
                console.error('表访问错误:', error);
                log('表访问失败: ' + error.message);
                updateStatus('表访问失败: ' + error.message, 'error');
            } finally {
                testTableBtn.disabled = false;
            }
        });
        
        // 页面加载时的初始化
        document.addEventListener('DOMContentLoaded', () => {
            log('页面已加载，等待测试连接...');
            log('请确保已在Supabase控制台中创建了game_accounts表并设置了适当的RLS策略');
        });
    </script>
</body>
</html>