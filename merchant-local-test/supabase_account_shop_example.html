<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase账号商场示例</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 引入Supabase客户端库 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <header class="mb-10">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Supabase账号商场示例</h1>
            <p class="text-gray-600 text-center">连接Supabase数据库的账号展示与管理</p>
        </header>

        <!-- 连接配置部分 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Supabase连接配置</h2>
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-700 mb-2" for="supabase_url">Supabase URL:</label>
                    <input type="text" id="supabase_url" class="w-full px-3 py-2 border border-gray-300 rounded-md" 
                           placeholder="https://your-project.supabase.co">
                </div>
                <div>
                    <label class="block text-gray-700 mb-2" for="supabase_key">Supabase Anon Key:</label>
                    <input type="text" id="supabase_key" class="w-full px-3 py-2 border border-gray-300 rounded-md" 
                           placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
                </div>
            </div>
            <button id="connect-btn" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded-md transition-colors">
                <i class="fa fa-link mr-2"></i>连接到Supabase
            </button>
            <div id="connection-status" class="mt-3 text-sm hidden"></div>
        </div>

        <!-- 功能区 -->
        <div class="grid md:grid-cols-2 gap-8">
            <!-- 账号列表 -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">账号列表</h2>
                    <button id="fetch-accounts" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-md text-sm transition-colors">
                        <i class="fa fa-refresh mr-1"></i>获取账号
                    </button>
                </div>
                <div id="accounts-container" class="space-y-4 max-h-96 overflow-y-auto">
                    <p class="text-gray-500 text-center py-8">请先连接Supabase并点击获取账号</p>
                </div>
            </div>

            <!-- 发布新账号 -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">发布新账号</h2>
                <form id="publish-form" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 mb-1" for="account_name">账号名称:</label>
                        <input type="text" id="account_name" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 mb-1" for="account_level">等级:</label>
                            <input type="number" id="account_level" min="1" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1" for="price">价格:</label>
                            <input type="number" id="price" min="0" step="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <label class="block text-gray-700 mb-1 text-xs" for="haf_coin">金币:</label>
                            <input type="number" id="haf_coin" min="0" step="0.01" required class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1 text-xs" for="stamina_level">体力:</label>
                            <input type="number" id="stamina_level" min="1" required class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1 text-xs" for="weight_level">负重:</label>
                            <input type="number" id="weight_level" min="1" required class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm">
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1" for="description">描述:</label>
                        <textarea id="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 mb-1" for="image_url">图片URL:</label>
                            <input type="url" id="image_url" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1" for="taobao_link">淘宝链接:</label>
                            <input type="url" id="taobao_link" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1" for="published_by">发布者:</label>
                        <input type="text" id="published_by" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 rounded-md transition-colors">
                        <i class="fa fa-paper-plane mr-2"></i>发布账号
                    </button>
                </form>
            </div>
        </div>

        <!-- 操作日志 -->
        <div class="mt-8 bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">操作日志</h2>
            <div id="logs" class="bg-gray-50 p-4 rounded-md max-h-48 overflow-y-auto text-sm text-gray-700">
                <p>等待操作...</p>
            </div>
        </div>
    </div>

    <script>
        // 全局Supabase客户端实例
        let supabase = null;
        let createClient = null;
        
        // 等待页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 尝试获取Supabase客户端创建函数
            // 新版本的Supabase JS库可能直接挂载到window.supabase
            if (window.supabase && window.supabase.createClient) {
                createClient = window.supabase.createClient;
            } 
            // 旧版本或特定版本可能挂载到window
            else if (window.createClient) {
                createClient = window.createClient;
            }
            
            // 显示初始化状态
            const statusDiv = document.createElement('div');
            statusDiv.id = 'supabase-init-status';
            statusDiv.className = 'fixed bottom-4 right-4 px-4 py-2 rounded-md text-sm font-medium';
            
            if (createClient) {
                statusDiv.textContent = 'Supabase库加载成功';
                statusDiv.style.backgroundColor = '#d1fae5';
                statusDiv.style.color = '#065f46';
            } else {
                statusDiv.textContent = 'Supabase库加载失败，请检查网络连接';
                statusDiv.style.backgroundColor = '#fee2e2';
                statusDiv.style.color = '#991b1b';
            }
            
            document.body.appendChild(statusDiv);
            
            // 3秒后自动隐藏状态提示
            setTimeout(() => {
                statusDiv.style.transition = 'opacity 0.3s ease';
                statusDiv.style.opacity = '0';
                setTimeout(() => statusDiv.remove(), 300);
            }, 3000);
        });
        
        // DOM元素
        const connectBtn = document.getElementById('connect-btn');
        const supabaseUrl = document.getElementById('supabase_url');
        const supabaseKey = document.getElementById('supabase_key');
        const connectionStatus = document.getElementById('connection-status');
        const fetchBtn = document.getElementById('fetch-accounts');
        const accountsContainer = document.getElementById('accounts-container');
        const publishForm = document.getElementById('publish-form');
        const logsContainer = document.getElementById('logs');
        
        // 日志函数
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logClass = type === 'success' ? 'text-green-600' : 
                           type === 'error' ? 'text-red-600' : 
                           type === 'warning' ? 'text-yellow-600' : 'text-gray-700';
            const logEntry = document.createElement('p');
            logEntry.className = `${logClass} mb-1`;
            logEntry.innerHTML = `<span class="font-medium">[${timestamp}]</span> ${message}`;
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }
        
        // 连接到Supabase
        connectBtn.addEventListener('click', async () => {
            const url = supabaseUrl.value.trim();
            const key = supabaseKey.value.trim();
            
            if (!url || !key) {
                connectionStatus.textContent = '请填写Supabase URL和Key';
                connectionStatus.className = 'text-red-500 block';
                log('请填写Supabase URL和Key', 'error');
                return;
            }
            
            try {
                connectBtn.disabled = true;
                connectBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>连接中...';
                
                // 检查createClient是否可用
                if (!createClient) {
                    // 尝试作为后备方案直接使用全局supabase对象
                    if (window.supabase && window.supabase.createClient) {
                        createClient = window.supabase.createClient;
                    } else {
                        throw new Error('无法找到Supabase客户端创建函数，请刷新页面重试');
                    }
                }
                
                // 初始化Supabase客户端
                supabase = createClient(url, key);
                
                // 测试连接
                const { data, error } = await supabase.from('game_accounts').select('id').limit(1);
                
                if (error) {
                    throw error;
                }
                
                connectionStatus.textContent = '连接成功！';
                connectionStatus.className = 'text-green-500 block';
                log('成功连接到Supabase', 'success');
                
                // 自动获取账号列表
                fetchAccounts();
                
            } catch (error) {
                connectionStatus.textContent = `连接失败: ${error.message}`;
                connectionStatus.className = 'text-red-500 block';
                log(`连接失败: ${error.message}`, 'error');
                supabase = null;
            } finally {
                connectBtn.disabled = false;
                connectBtn.innerHTML = '<i class="fa fa-link mr-2"></i>连接到Supabase';
            }
        });
        
        // 获取账号列表
        fetchBtn.addEventListener('click', fetchAccounts);
        
        async function fetchAccounts() {
            if (!supabase) {
                log('请先连接到Supabase', 'warning');
                return;
            }
            
            try {
                fetchBtn.disabled = true;
                fetchBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-1"></i>加载中...';
                accountsContainer.innerHTML = '<p class="text-gray-500 text-center py-8">加载中...</p>';
                
                // 从Supabase获取账号数据
                const { data, error } = await supabase
                    .from('game_accounts')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    throw error;
                }
                
                if (data.length === 0) {
                    accountsContainer.innerHTML = '<p class="text-gray-500 text-center py-8">暂无账号数据</p>';
                    log('获取到0个账号', 'info');
                } else {
                    // 渲染账号卡片
                    accountsContainer.innerHTML = data.map(account => `
                        <div class="border border-gray-200 rounded-lg p-4 card-shadow">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-semibold text-lg">${account.account_name}</h3>
                                <span class="text-red-600 font-bold">¥${account.price}</span>
                            </div>
                            <div class="text-sm text-gray-600 mb-2">
                                <span class="mr-3"><i class="fa fa-signal"></i> 等级 ${account.account_level}</span>
                                <span class="mr-3"><i class="fa fa-coffee"></i> 体力 ${account.stamina_level}</span>
                                <span><i class="fa fa-balance-scale"></i> 负重 ${account.weight_level}</span>
                            </div>
                            <p class="text-sm text-gray-500 mb-2 line-clamp-2">${account.description || '暂无描述'}</p>
                            <div class="flex justify-between items-center text-xs text-gray-400">
                                <span>发布者: ${account.published_by}</span>
                                <span>${account.published_at}</span>
                            </div>
                        </div>
                    `).join('');
                    log(`成功获取到 ${data.length} 个账号`, 'success');
                }
                
            } catch (error) {
                accountsContainer.innerHTML = `<p class="text-red-500 text-center py-8">获取失败: ${error.message}</p>`;
                log(`获取账号失败: ${error.message}`, 'error');
            } finally {
                fetchBtn.disabled = false;
                fetchBtn.innerHTML = '<i class="fa fa-refresh mr-1"></i>获取账号';
            }
        }
        
        // 发布新账号
        publishForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!supabase) {
                log('请先连接到Supabase', 'warning');
                return;
            }
            
            try {
                const submitBtn = publishForm.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>发布中...';
                
                // 获取表单数据
                const accountData = {
                    account_name: document.getElementById('account_name').value,
                    account_level: parseInt(document.getElementById('account_level').value),
                    haf_coin: parseFloat(document.getElementById('haf_coin').value),
                    stamina_level: parseInt(document.getElementById('stamina_level').value),
                    weight_level: parseInt(document.getElementById('weight_level').value),
                    price: parseFloat(document.getElementById('price').value),
                    description: document.getElementById('description').value,
                    image_url: document.getElementById('image_url').value,
                    taobao_link: document.getElementById('taobao_link').value,
                    published_by: document.getElementById('published_by').value,
                    published_at: new Date().toLocaleString('zh-CN')
                };
                
                // 插入到Supabase
                const { data, error } = await supabase
                    .from('game_accounts')
                    .insert([accountData]);
                
                if (error) {
                    throw error;
                }
                
                log('账号发布成功！', 'success');
                
                // 重置表单
                publishForm.reset();
                
                // 刷新账号列表
                fetchAccounts();
                
            } catch (error) {
                log(`发布账号失败: ${error.message}`, 'error');
                alert(`发布失败: ${error.message}`);
            } finally {
                const submitBtn = publishForm.querySelector('button[type="submit"]');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fa fa-paper-plane mr-2"></i>发布账号';
            }
        });
        
        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', () => {
            log('页面已加载，等待连接Supabase...');
        });
    </script>
</body>
</html>